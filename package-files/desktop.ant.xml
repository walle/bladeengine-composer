<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="dist" name="Create dist packages for Desktop">

	<property name="launch4j.dir" location="launch4j" />
	<property name="main.class" value="org.bladecoder.engine.desktop.Main" />
	<property name="icon" location="icon.ico" />

	<target name="jar">
	    <delete file="${dist}/${name}.jar"/>
	    
		<jar destfile="${dist}/${name}.jar" filesetmanifest="mergewithoutmain">
			<manifest>
				<attribute name="Main-Class" value="${main.class}" />
				<attribute name="Class-Path" value="." />
				<attribute name="Version" value="${version}" />
			</manifest>

			<zipfileset excludes="META-INF/*.SF" src="engine/blade-engine.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/engine-desktop.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx-backend-lwjgl-natives.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx-backend-lwjgl.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx-freetype-natives.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx-freetype.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx-natives.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/gdx.jar" />
			<zipfileset excludes="META-INF/*.SF" src="engine/spine-libgdx.jar" />
			
			<fileset dir="${project}/bin" excludes="assets"/>
			<fileset dir="${project}/assets" />
		</jar>
		
		<chmod file="${dist}/${name}.jar" perm="a+x"/>
	</target>
	
   <macrodef name="build-linux">
       <attribute name="arch" default="linux64"/>
       <attribute name="jre" default="../../engine-dist/jre-linux64"/>
        <sequential>
		<echo file="${dist}/${name}.sh" append="false">#!/bin/sh
cd "`dirname \"$0\"`"
./jre-@{arch}/bin/java -server -Xmx1024M -jar ${name}.jar "${@}"
		</echo>
		
		<echo file="${dist}/${name}Windowed.sh" append="false">#!/bin/sh
cd "`dirname \"$0\"`"
./jre-@{arch}/bin/java -server -Xmx1024M -jar ${name}.jar -w "${@}"
		</echo>                     
            
		<tar destfile="${dist}/${name}-@{arch}.tgz" compression="gzip">
			<tarfileset file="${dist}/${name}.sh" filemode="755" prefix="${name}/"/>
			<tarfileset file="${dist}/${name}Windowed.sh" filemode="755" prefix="${name}/"/>
			<tarfileset file="${dist}/${name}.jar" filemode="755" prefix="${name}/"/>
					
			<mappedresources>
				<fileset dir="@{jre}" excludes="bin/java"/>
				<globmapper from="*" to="${name}/jre-@{arch}/*" />
			</mappedresources>
			
			<tarfileset file="@{jre}/bin/java" filemode="755" prefix="${name}/jre-@{arch}/bin/"/>
		</tar>
		
		<delete file="${dist}/${name}.sh"/>
		<delete file="${dist}/${name}Windowed.sh"/>
		</sequential>
	</macrodef>
	

	<target name="linux32" depends="jar">
		<build-linux arch="linux32"  jre="${linux32.jre}"/>
	</target>

	<target name="linux64" depends="jar">
		<build-linux arch="linux64" jre="${linux64.jre}"/>
	</target>

	<target name="exe" depends="jar">
		<taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask"
			classpath="${launch4j.dir}/launch4j.jar
		    :${launch4j.dir}/lib/xstream.jar" />
		<launch4j>
			<config headerType="gui" outfile="${dist}/${name}.exe" errTitle="${name}"
				chdir="." icon="${icon}" jarPath="${name}.jar"
				dontWrapJar="true">
				<jre minVersion="1.6.0" path="jre-win">
<!-- 					<opt>-server</opt> -->
				</jre>
			</config>
		</launch4j>
	</target>

	<target name="win" depends="exe">
	    <delete file="${dist}/${name}-win.zip"/>
	    
		<zip destfile="${dist}/${name}-win.zip">
			<zipfileset file="${dist}/${name}.exe" prefix="${name}/"/>
			<zipfileset file="${dist}/${name}.jar"  prefix="${name}/"/>
			<zipfileset dir="${win.jre}" prefix="${name}/jre-win"/>
		</zip>
		
		<delete file="${dist}/${name}.exe"/>
	</target>

	<target name="dist" depends="linux32, linux64, win">
<!-- 		<delete file="${dist}/${name}.jar"/> -->
	</target>
</project>
